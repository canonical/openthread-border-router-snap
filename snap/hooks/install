#!/bin/bash -ex

TAG="openthread-border-router.install"

logger --tag=$TAG "Start"

# Somehow the `with` function isn't able to read off examples/platforms/ubuntu/default
# So, setting the default manually here:
# export NAT64=1 \
#        DNS64=0 \
#        DHCPV6_PD=0 \
#        NETWORK_MANAGER=0 \
#        BACKBONE_ROUTER=1 \
#        BORDER_ROUTING=1 \
#        WEB_GUI=1 \
#        REST_API=1

logger --tag=$TAG "env: $(env)"

###############################################################################
logger --tag=$TAG "Install the firewall"
# TODO: The firewall rules will not persist on reboot
$SNAP/bin/script/otbr-firewall start

# Custom initrc without staging and build logic
export PLATFORM=ubuntu
source $SNAP/bin/_initrc_install

###############################################################################
logger --tag=$TAG "Install IP forwarding"
source $SNAP/bin/script/_ipforward
# NOTE:
# The following also calls ipforward_enable which makes changes under /proc/sys/net/
# but there is no upstream implementation to revert it!
ipforward_install

###############################################################################
logger --tag=$TAG "Install RT Tables for the Backbone Router"

export BACKBONE_ROUTER=1
source $SNAP/bin/script/_rt_tables
# NOTE:
# The following also makes changes to /etc/sysctl.conf 
# but there is no upstream implementation to revert it!
rt_tables_install


###############################################################################
logger --tag=$TAG "Install NAT44"
# TODO: The firewall rules will no persist.
$SNAP/bin/nat44_install

logger --tag=$TAG "End"
